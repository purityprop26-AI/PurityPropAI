# ==============================================
# Docker Compose â€” Development & Testing
# ==============================================

services:
  intelligence-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: purityprop-intelligence
    ports:
      - "${PORT:-8000}:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.1-8b-instant}
      - APP_ENV=${APP_ENV:-development}
      - DEBUG=${DEBUG:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DB_POOL_SIZE=${DB_POOL_SIZE:-5}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-10}
    env_file:
      - backend/.env
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - purityprop-net
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M

  # Prometheus metrics exporter (optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: purityprop-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./cicd/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - purityprop-net
    profiles:
      - monitoring

networks:
  purityprop-net:
    driver: bridge
